# **هرم الاختبارات**

Pipeline في CI/CD:  
**Lint → Unit → Widget/Golden → Integration/E2E (على أجهزة) → Build/Sign → Release → Post-release Monitoring**.  
كل طبقة تمنع دخول أخطاء للتي بعدها، ومعها عتبات قبول (Gates) واضحة.

# **1\) Unit Tests — اختبارات الوحدات**

**الهدف:** تأكيد منطق الأعمال سريعًا ومعزولًا عن الـUI والشبكة.  
**نغطي:** الدوال والخدمات وUseCases/Repositories (بتبديل المصادر بمُحاكيات).  
**أمثلة:** حساب السعر بعد الكوبون، شروط صلاحية الكوبون، تنسيقات العناوين، مُولِّد مفاتيح idempotency.  
**أدوات:** `flutter_test`, `mocktail/Mockito`, `fake_async`.  
**بيانات الاختبار:** Fixtures صغيرة وثابتة، لا اتصالات حقيقية.  
**بوابة القبول:** نجاح 100%، وتغطية ≥ **80%** للمنطق الحرج.  
**مقاييس:** زمن الاختبار \< 200ms/اختبار، عدم flakiness.

# **2\) Widget / Golden — واجهة معزولة \+ لقطات ثابتة**

**الهدف:** ضمان سلوك الواجهة وعرض الحالات (loading/empty/error) وثبات الشكل بصريًا.  
**Widget نغطي:** عناصر مثل بطاقة منتج، شريط الإضافة للسلة، نماذج الإدخال…  
**Golden (لقطات):** مقارنة Pixel-perfect لصفحات/مكوّنات أساسية (Error screen، بطاقة PLP، شاشة PDP).  
**أدوات:** `flutter_test` (pumpWidget)، ولقطات `matchesGoldenFile` (يمكن استخدام golden\_toolkit).  
**بيئة:** خطوط/مقاسات ثابتة، صور وهمية (placeholders)، تعطيل الرسوم المتحركة.  
**بوابة القبول:** 100% نجاح لواجهات أساسية \+ عدم تغيّر ملفات Golden دون مبرر.  
**مقاييس:** تغطية حالات الحالة (states) لكل Widget أساسي.

# **3\) Integration / E2E — رحلة كاملة على جهاز**

**الهدف:** اختبار “رحلات حرجة” كأنها مستخدم حقيقي، من داخل التطبيق حتى الـAPI.  
**نغطي:** Auth → PLP → PDP → AddToCart → Coupon → Address → Shipping → Payment(3DS) → Order.  
**أدوات:** حزمة Flutter **`integration_test`** (الرسمية) \+ تشغيل على **محاكٍ/جهاز فعلي** (iOS/Android). يمكن إضافة أدوات مثل Patrol/Appium عند الحاجة.  
**البيئة والبيانات:**

* حسابات اختبار، منتجات مهيّأة (مخزون/أسعار معروفة)، قسائم صحيحة/خاطئة.  
* شبكة: ملفات تعريف 3G/ضعيفة، لغتان (AR/EN)، وضع داكن/فاتح.  
  **بوابة القبول:** نجاح 100% لرحلة واحدة على الأقل لكل منصة \+ عدم flakiness.  
  **مقاييس:** زمن كل خطوة (P95) ضمن الميزانية (مثال: Checkout step ≤ 1.5s)، معدل النجاح عبر الجهاز/الإصدار.

# **4\) Post-release Monitoring — مراقبة ما بعد الإطلاق**

**الهدف:** اصطياد ما يفلت من الاختبارات على أجهزة المستخدمين الحقيقية.  
**الأدوات:** **Crashlytics/Sentry** (أعطال)، **Firebase Performance** (بدء/شبكة/إطارات)، **GA4** (الفانِل)، تنبيهات.  
**ما نراقب:**

* Crash-free sessions (%)، Start-up P95، مهلة/أخطاء الشبكة، Funnel التحويل (من open إلى purchase).  
* مقارنات cohort للإصدار الجديد مقابل السابق، وإيقاف طرح تلقائي عند كسر العتبات.  
  **بوابة القبول (للطرح):**  
* Crash-free ≥ **98.5%**، وعدم هبوط **Checkout Conversion** أكثر من −15% مقارنة بالإصدار السابق.  
  **إجراءات:** Runbooks (Incident/Hotfix/Rollback)، تذاكر جذور المشكلة، تحسينات لاحقة.

---

## **جدول سريع (لكل طبقة)**

| الطبقة | لماذا؟ | يغطي | أدوات | بيانات | بوابة القبول | مقاييس أساسية |
| ----- | ----- | ----- | ----- | ----- | ----- | ----- |
| Unit | حماية المنطق | UseCases/Repos | flutter\_test \+ mocktail | Fixtures | نجاح 100% \+ تغطية ≥80% | زمن \<200ms/اختبار |
| Widget/Golden | ثبات الواجهة | Widgets/States/Visual | flutter\_test \+ golden | صور/خطوط ثابتة | 100% للشاشات الأساسية | صفر تغيّر بصري غير مبرر |
| Integration/E2E | صحة الرحلات | تدفقات الشراء | integration\_test | حسابات/منتجات/قسائم | نجاح كامل على iOS/Android | P95 ضمن الميزانية |
| Post-release | صحة على أرض الواقع | Crash/Perf/Funnel | Crashlytics/Perf/GA4 | بيانات حية | SLOs محققة | Crash-free ≥98.5% |

**ملاحظة///**  
اجعل أي PR يمرّ بـ Unit \+ Widget/Golden. نفّذ Integration/E2E ليليًا وعلى كل **Release Candidate**. وبعد الإطلاق، راقب SLOs تلقائيًا مع **Auto-rollback/Stop Rollout** إذا انكسرت العتبات.


---

## 🏠 **Back to Home | العودة للرئيسية**

[← Back to Main Index | العودة للفهرس الرئيسي](../../../index.html)

---
