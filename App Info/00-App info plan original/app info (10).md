**5\) الأمان داخل التطبيق (Security Layer)**

## **الفائدة**

* حماية بيانات العميل (الحساب، العناوين، الطلبات).  
* منع إساءة استخدام الواجهات (API) وتقليل الفواتير الناتجة عن الهجمات.  
* الالتزام بالممارسات الجيدة للخصوصية والثقة بالعلامة.

---

## **المطلوب من التنفيذ**

### **A) جلسات المستخدم والرموز (Tokens)**

* استخدام **Firebase ID Token** حصريًا في ترويسة `Authorization: Bearer <token>`.  
* **تحديث تلقائي** للرمز قبل انتهاء صلاحيته؛ عند الفشل → الانتقال لصفحة الدخول.  
* حفظ الرمز ومعلومات الجلسة في **تخزين آمن** (Keychain/iOS, Keystore/Android) وليس في SharedPrefs العادية.  
* عند **تسجيل الخروج**: مسح كل الرموز والكاش الحساس (سلة/عناوين).

### **App Check (B  (إثبات أصل التطبيق)**

* إرسال ترويسة `X-App-Check` مع كل طلبات الشبكة (إن فُعّل في الـBackend).  
* معالجة أخطاء App Check برسائل ودّية (اطلبي التحديث/أعيدي المحاولة).

### **C) الاتصالات الشبكية**

* إلزام **HTTPS فقط**؛ تعطيل أي قبول لشهادات غير موثوقة.  
* **(اختياري مفضّل)**: تفعيل **SSL Pinning** لزيادة الحماية من MITM.  
* ضبط مهلات ومعاودة محاولات ذكية (Exponential Backoff) مع سقف محاولات.

### **D) الروابط العميقة والتنقّل (Deep Links)**

* السماح بروابط من **قائمة نطاقات موثوقة فقط**.  
* التحقق من **المعلمات** قبل استخدامها (لا تعتمد قيم URL مباشرة في منطق حساس).  
* أي رابط ناقص/مريب → شاشة آمنة برسالة خطأ عامة.

### **E) البيانات المحلية (Local Data)**

* تشفير ما يمكن تشفيره (العناوين، السلة إن كانت تتضمن أسعار تفصيلية).  
* تنظيف الكاش عند تسجيل الخروج أو عند تبديل الحساب.  
* منع النسخ الاحتياطي السحابي للبيانات الحساسة (Android: `allowBackup=false`، iOS: استثناء الملفات الحساسة من iCloud backup).

### **F) الخصوصية والـPII**

* **لا** نخزن أو نرسل أبدًا: رقم OTP، كلمات مرور، مفاتيح سرية.  
* الحد الأدنى من الـPII في الذاكرة والتخزين.  
* إخفاء/تقليل ظهور البيانات الحساسة في **السجلات (Logs)**؛ **حظر** طباعة التوكن أو الـheaders.

### **G) السلوك على الشاشة**

* (اختياري حسب الحاجة) منع لقطات الشاشة في شاشات حسّاسة (Android FLAG\_SECURE).  
* إخفاء الحقول الحساسة عند الانتقال للخلفية (Blur View عند الـApp Switcher) — حسب السياسة.

### **H) صلاحيات النظام (Permissions)**

* طلب الحد الأدنى من الصلاحيات وبالزمن المناسب (Just-in-time).  
* شروحات عربية واضحة لسبب طلب الصلاحية.

### **I) إدخال المستخدم (Validation)**

* التحقق محليًا من تنسيقات شائعة (الهاتف بصيغة E.164، الحقول المطلوبة).  
* Sanitization للنصوص الحرّة قبل الإرسال (منع رموز تحكم/أطوال غير منطقية).

### **J) التعامل مع الأخطاء**

* رسائل **عامة** للمستخدمة (بدون تفاصيل تقنية).  
* تعيين أكواد داخلية للأخطاء (mapping) كما تم تعريفه مسبقًا.  
* تسجيل الأخطاء تقنيًا داخليًا بدون أي PII.

### **K) حماية إجراءات حسّاسة**

* قبل إجراءات مثل **حذف الحساب/تغيير رقم الهاتف**: إعادة تحقق (Re-auth) وواجهة تأكيد مزدوج.  
* **Checkout/Payment**: إنشاء **Idempotency-Key** على الجهاز لكل عملية وإرساله مع الطلب (لتفادي التكرار عند ضعف الشبكة).

---

## **Definition of Done (اعتماد)**

* جميع طلبات الشبكة ترفق `Authorization` (+ `X-App-Check` عند التفعيل).  
* الرموز مخزّنة في Keychain/Keystore، وتُمسح كليًا عند تسجيل الخروج.  
* الاتصالات HTTPS صارمة؛ (إن فُعّل) SSL Pinning يعمل دون كسر التدفق.  
* Deep Links تعمل فقط من نطاقات موثوقة، ومع فحص معلمات آمن.  
* لا وجود لتوكنات/PII في السجلات، وتم تفعيل Redaction للّوجات.  
* عند انتهاء الجلسة تظهر رسالة دخول موحّدة والتطبيق يحول المستخدم لسياق آمن.  
* إجراءات حسّاسة تتطلب re-auth وتأكيدًا داخل الواجهة.  
* Idempotency-Key يُرسل في مسارات الشراء/الدفع وتم اختبار تكرار الطلب.

---

## **تسليمات**

* **SecurityConfig**: إعدادات الشبكة (TLS فقط، مهلات، Backoff).  
* **TokenStore**: طبقة تخزين آمن للرموز مع واجهة (get/set/clear).  
* **AppCheckInterceptor**: إضافة ترويسة App Check تلقائيًا.  
* **DeepLinkGuard**: طبقة تحقق لنطاقات ومعلمات الروابط.  
* **LogRedactor**: أداة لإخفاء الحساسيّات في السجلات.  
* **SecureCache**: واجهة لتخزين محلي مشفر لما يلزم (إن تقررنا تشفير عناصر معينة).  
* وثيقة **Permissions Policy** (ما الذي نطلبه ولماذا ومتى).  
* **اختبارات**:  
  * انتهاء جلسة → إعادة توجيه صحيحة.  
  * تسجيل خروج → مسح تام للرموز والكاش.  
  * Deep Link غير موثوق → يُمنع بأمان.  
  * (إن وُجد) SSL Pinning → فشل الشهادة المزوّرة يمنع الاتصال.  
  * إرسال Idempotency-Key وتأكيد منع التكرار.

---

## **أخطاء يجب تجنبها**

* تخزين التوكن في SharedPreferences/NSUserDefaults بدون تشفير.  
* طباعة التوكن/الهيدر في الـLogs أو إرسالها لتحليلات.  
* قبول أي Deep Link بلا تحقق نطاق/معلمات.  
* رسائل خطأ تفصح عن تفاصيل سيرفر/استثناءات.  
* تجاهل مسح الكاش الحساس عند تسجيل الخروج.  
* استدعاء Checkout/Payment **بدون** Idempotency-Key.

---

## **ملاحظات تشغيلية (للتنسيق مع الـBackend)**

* في الرد على 401/403: ارجاع كود واضح ليفهم العميل أنه يحتاج تسجيل دخول.  
* تفعيل **Rate Limiting** و**WAF** في الخادم؛ العميل يطبّق Backoff ويحترم 429\.  
* اعتماد **سقف أحجام JSON** مع رسائل مفهومة إذا تم تجاوزه.  
* توحيد أكواد الأخطاء (ZH-XXXX) مع جدول الـmapping في التطبيق.

---

## **1\. SecurityConfig**

**الاستفادة:** يضمن أن كل الاتصالات مع الخادم آمنة (HTTPS فقط) مع مهلات وضبط محاولات إعادة الطلب.  
**الطريقة:** إعداد عميل الشبكة (HttpClient/Retrofit/Alamofire) ليقبل TLS فقط، يرفض الشهادات غير الموثوقة، مع مهلة (Timeout) محددة \+ سياسة Backoff عند الفشل.

**2\. TokenStore**

**الاستفادة:** حماية رموز الدخول (Tokens) ومنع سرقتها أو قراءتها من تطبيقات أخرى.  
**الطريقة:** تخزين الرموز داخل Keychain (iOS) أو Keystore/EncryptedSharedPrefs (Android). مسحها تلقائيًا عند تسجيل الخروج.

## **3\. AppCheckInterceptor**

**الاستفادة:** التأكد أن الطلبات تأتي من تطبيق “زهراء” الحقيقي فقط، وتقليل الهجمات الآلية.  
**الطريقة:** إضافة Interceptor في عميل الشبكة لإرسال Header:

`X-App-Check: <token>`

مع كل طلب، والتحقق من رد الخادم عند الفشل.

**4\. DeepLinkGuard**

**الاستفادة:** منع أي رابط مزيف من فتح التطبيق أو إدخال قيم ضارة.  
**الطريقة:** تحديد قائمة نطاقات مسموحة (whitelist مثل `zahraah.com`) \+ فحص المعلمات قبل التنقل. روابط غير مطابقة → تعرض شاشة آمنة برسالة خطأ.

**5\. LogRedactor**

**الاستفادة:** حماية السجلات (Logs) من تسرب بيانات حساسة مثل الرموز أو الأرقام.  
**الطريقة:** إنشاء أداة (Utility) تستبدل القيم الحساسة بـ `***` عند الطباعة أو الإرسال لـCrashlytics.

## **6\. SecureCache**

**الاستفادة:** حماية البيانات المحلية (مثل العناوين أو السلة) من الوصول غير المصرح به.  
**الطريقة:** استخدام تخزين مشفر (EncryptedSharedPrefs/SQLCipher) لتخزين البيانات الحساسة، مع تنظيفها عند تسجيل الخروج.

## **7\. Permissions Policy**

**الاستفادة:** تقليل رفض التطبيق من المتاجر وزيادة ثقة المستخدم عبر طلب أقل صلاحيات وبشفافية.  
**الطريقة:** كتابة ملف `Permissions.md` يوضح:

* ما هي الصلاحية؟ (مثال: الكاميرا)  
* لماذا نطلبها؟ (رفع صورة الملف الشخصي)  
* متى نطلبها؟ (عند الحاجة فقط – Just-in-time).

**8\. Idempotency in Checkout/Payment**

**الاستفادة:** منع تكرار الطلب أو الدفع عند ضعف الإنترنت أو إعادة المحاولة.  
**الطريقة:** إنشاء مفتاح فريد `Idempotency-Key` عند كل عملية Checkout/Payment وإرساله في Header، ويتحقق الخادم أن العملية لا تُنفذ مرتين.


---

## 🏠 **Back to Home | العودة للرئيسية**

[← Back to Main Index | العودة للفهرس الرئيسي](../../../index.html)

---
