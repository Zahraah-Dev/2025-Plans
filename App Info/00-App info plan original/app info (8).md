# **3\) طبقة البيانات (Repositories \+ API Client \+ Cache)**

## **لماذا (الفائدة)**

* واجهة موحّدة للوصول للبيانات بغضّ النظر عن مصدرها (شبكة/محلي).  
* تمكين العمل **أوفلاين جزئي** وتحسين سرعة التطبيق.

## **ما المطلوب تنفيذه**

* **Repository لكل مجال:** `ProductsRepository, CartRepository, OrdersRepository, AuthRepository…`  
* **RemoteDataSource:** عميل REST موحّد، ترويسات ثابتة (Authorization, App-Check, Request-Id)، ترقيم صفحات، معالجة أخطاء معيارية.  
* **LocalDataSource (Cache):**  
  * Cache للـ Lists (الصفحة الأولى على الأقل) \+ تفاصيل المنتج.  
  * تفضيلات خفيفة (اللغة/العملة/المستخدم) في تخزين محلي آمن.  
* **سياسة التحديث:** **Stale-While-Revalidate**  
  * اعرض الكاش فورًا، وجدّد من الشبكة بالخلفية، وحدّث الـViewModel عند وصول البيانات.  
* **النماذج (Models):**  
  * **Domain Models** لا تعتمد على JSON.  
  * **DTOs** للتحويل من/إلى الـAPI فقط (Mapper واضح بينهما).  
* **التعامل مع الأخطاء:** تحويل أكواد الشبكة إلى أخطاء مجال مفهومة (مثلاً ZH-VALID-422 → خطأ إدخال).  
* **الأمان:** حفظ الرموز (Tokens) محليًا بشكل آمن، وتنظيفها عند تسجيل الخروج.

## **Definition of Done (اعتماد)**

* عميل API موحّد يعمل مع Timeouts وRetry محدود.  
* Repositories فعّالة لشاشات: قائمة المنتجات، تفاصيل منتج، السلة، الطلب.  
* Cache يعمل ويظهر فرق السرعة بين الفتح الأول والثاني.  
* تحويل DTO ↔ Domain عبر Mapper مُختبر.  
* تغطية أخطاء الشبكة شاملة (عدم وجود إنترنت/مهلة/422/401…)، والـUI تعرض رسائل عربية مناسبة.

## **تسليمات**

* جدول Endpoints الأساسية المطلوبة (أسماء فقط الآن، التفاصيل لاحقًا من مستند الـAPI).  
* قائمة DTOs \+ Domain Models لكل مورد.  
* سياسة الـCaching لكل شاشة (ما يُخزّن، مدة الصلاحية، متى يُحدّث).  
* خريطة الأخطاء وتحويلها لرسائل واجهة.

## **أخطاء شائعة يجب تجنبها**

* استخدام نفس النموذج لـDomain وDTO → افصل بينهما.  
* إشغال الـUI بانتظار الشبكة دائمًا → افتح بالكاش ثم حدّث.  
* تجاهل الترقيم/الفلترة في القوائم → التزم بعقد موحّد.

## **1\) جدول Endpoints الأساسية المطلوبة**

الغرض: المبرمج يعرف أي مسارات API سيبني عليها الشاشات. (نكتبها أسماء فقط، التفاصيل الدقيقة تكون في مستند الـAPI الرسمي).

| الشاشة / الميزة | Endpoint الأساسي | الملاحظات |
| ----- | ----- | ----- |
| الصفحة الرئيسية / الفئات | `GET /categories` | جلب الفئات مع الصور |
| قائمة المنتجات | `GET /products?category_id=...` | مع ترقيم صفحات |
| تفاصيل المنتج | `GET /products/{product_id}` | يتضمن variants والمخزون |
| البحث | `GET /search?q=...` | مع عدد النتائج |
| السلة | `GET /cart`, `POST /cart/items` | إضافة/تعديل/حذف عناصر |
| القسائم | `POST /coupons/validate` | إرجاع قيمة وصلاحية |
| الدفع / الشراء | `POST /checkout` | حجز المخزون وإنشاء order |
| الطلبات | `GET /orders`, `GET /orders/{id}` | استرجاع تاريخ الطلب |
| الإشعارات (تسجيل جهاز) | `POST /devices/register` | لحفظ fcm\_token |

---

## **2\) قائمة DTOs \+ Domain Models لكل مورد**

* **DTO (Data Transfer Object):** الشكل القادم من/إلى الـAPI (JSON).  
* **Domain Model:** الكائن الداخلي الذي يستخدمه التطبيق (أبسط/أوضح).

**`DTO:`**  
`{`  
  `"id": "123",`  
  `"name": "فستان تركي",`  
  `"price": 12000,`  
  `"currency": "YER",`  
  `"images": ["..."],`  
  `"variants": [`  
    `{"id": "v1", "size": "M", "color": "Black", "stock": 3}`  
  `]`  
`}`

* 

**`Domain Model:`**  
`class Product {`  
  `final String id;`  
  `final String name;`  
  `final int price;`  
  `final String currency;`  
  `final List<String> images;`  
  `final List<Variant> variants;`

* `}`

---

## **3\) سياسة الـCaching لكل شاشة**

تحدد **ماذا نخزن محليًا \+ مدة صلاحية التخزين \+ متى نحدّث**.

| الشاشة | ما يُخزن | مدة الصلاحية | سياسة التحديث |
| ----- | ----- | ----- | ----- |
| الصفحة الرئيسية | قائمة الفئات \+ منتجات أولية | 24 ساعة | جلب من الكاش أولًا ثم تحديث من الشبكة بالخلفية |
| تفاصيل المنتج | بيانات المنتج \+ الصور | 12 ساعة | جلب من الكاش ثم تحديث إذا تغير السعر/المخزون |
| السلة | عناصر السلة محليًا | دائم (حتى تسجيل خروج) | يُزامن عند كل دخول للشاشة |
| الطلبات | آخر 5 طلبات | 1 يوم | تحديث يدوي عبر سحب للتحديث |

---

## 

## **4\) خريطة الأخطاء وتحويلها لرسائل واجهة**

نحدد كيف يتحول كود الخطأ من الـAPI إلى رسالة عربية مفهومة تعرض في التطبيق.

| كود الـAPI | error\_code داخلي | الرسالة للواجهة |
| ----- | ----- | ----- |
| HTTP 401 / ZH-AUTH | `auth_401` | **يرجى تسجيل الدخول للمتابعة.** |
| HTTP 422 / ZH-VALID | `validation_422` | **رجاءً راجعي البيانات المدخلة.** |
| HTTP 404 | `not_found_404` | **العنصر غير متاح الآن.** |
| HTTP 409 / ZH-INV | `conflict_409` | **نفد المخزون لهذا المنتج.** |
| HTTP 500+ | `server_5xx` | **حدث خطأ مؤقت في الخادم.** |
| Timeout / NoNetwork | `network_offline` | **اتصالك بالإنترنت غير متوفر.** |

---

💡**خارطة طريق واضحة**:

* يعرف أي Endpoints يحتاج يبني لها استدعاءات.  
* عنده Models جاهزة للـData.  
* يعرف كيف يدير الكاش لكل شاشة.  
* عنده جدول يحوّل أي خطأ إلى رسالة واجهة موحدة.  
* كل طلب request يحتوي على meta\_data حول معلومات الجهاز والجلسة


---

## 🏠 **Back to Home | العودة للرئيسية**

[← Back to Main Index | العودة للفهرس الرئيسي](../../../index.html)

---
