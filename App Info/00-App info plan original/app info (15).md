# **طرق الاختبار (Flutter)**

## **1\) اختبار الوحدات Unit Tests**

**الهدف:** المنطق الصافي (Use-cases, Repositories, Validators).  
**الأدوات:** `flutter_test` \+ `mocktail`/`mockito`.  
**ما نختبره:**

* تسعير، ضرائب/شحن، حساب العربون للمحافظات.  
* منطق المخزون (Inventory Hold) والإلغاء بعد انتهاء المهلة.  
* قواعد الكوبونات (انتهى/حد أدنى/استثناء فئات).  
* محولات (DTO ↔︎ Entity) ومعالجة الأخطاء `Result/Failure`.  
  **قبول:** تغطية ≥ 80% للوحدات الحساسة (السلة، الدفع، المخزون).

## **2\) اختبار الواجهات Widget Tests**

**الهدف:** الـUI بدون شبكة.  
**الأدوات:** `flutter_test`, `golden_toolkit` (للصور الذهبية).  
**ما نختبره:**

* PLP/قائمة المنتجات: عرض بطاقة المنتج، Placeholder للصورة، RTL.  
* PDP: تبديل الألوان/المقاسات، رسالة نفاد المخزون، سعر الشحن الظاهر مبكرًا.  
* السلة/الملخّص: تحديث الكميات، تطبيق كوبون، منع “متابعة الدفع” عند أخطاء.  
  **قبول:** ثبات العناصر الأساسية، عدم وجود استثناءات/overflow.

## **3\) صور ذهبية Golden Tests (ثبات التصميم)**

**الهدف:** ثبات الشكل عبر الوقت وRTL.  
**الأدوات:** `golden_toolkit`.  
**لقطات مطلوبة:** شاشة البداية، PLP، PDP، checkout، شاشة خطأ الشبكة، شاشة لا اتصال.  
**قبول:** اختلاف بكسلات ≤ 0.5%.

## **4\) اختبارات تكامل Integration/E2E**

**الهدف:** رحلة عميل كاملة على جهاز حقيقي أو محاكي.  
**الأدوات:** `integration_test` (+ **Patrol** أو **Maestro** لتسهيل السيناريوهات).  
**سيناريوهات أساسية:**

1. **تصفح → إضافة للسلة → Checkout (صنعاء)**  
   * توقّع `cod_standard` وعدم طلب عربون.  
2. **Checkout (محافظة خارج صنعاء)**  
   * إظهار Modal عربون → قبول → إتمام الطلب.  
3. **كوبون غير صالح/منتهٍ**  
   * رسالة خطأ صحيحة وعدم تغيير السعر.  
4. **نفاد المخزون أثناء الإتمام**  
   * ظهور Conflict 409 → اقتراح بديل/رجوع للسلة.  
5. **تغيير العنوان قبل الدفع**  
   * إعادة حساب الشحن تلقائيًا.  
6. **Deeplink من إشعار**  
   * يفتح المنتج/الطلب الصحيح.  
     **قبول:** نجاح الرحلة بنسبة 100% على أقلّ تقدير لجهازين (Android \+ iOS).

## **5\) اختبارات الشبكة والعدم اتصال**

**الهدف:** ملاءمة التطبيق لبيئة إنترنت ضعيفة.  
**الأدوات:** محاكي الشبكة (Android Studio/Charles/Network Link Conditioner)، Interceptors.  
**السيناريوهات:**

* **Timeout**: إظهار رسالة “الخدمة بطيئة”.  
* **No Connection**: شاشة “غير متصل” \+ زر محاولـة مجددًا.  
* **Retry \+ Backoff**: فشل أول/نجاح ثاني.  
* **Offline Queue**: إضافة للسلة/المفضلة/العنوان أوفلاين ثم تزامن عند عودة الشبكة.  
  **قبول:** عدم انهيار التطبيق، رسائل عربية واضحة، عدم فقدان تغييرات المستخدم.

## **6\) اختبارات الأداء Performance**

**الهدف:** الالتزام بالميزانيات.  
**الأدوات:** `flutter drive`/`integration_test` مع `Timeline`, DevTools (CPU/Memory), Firebase Performance (اختياري).  
**المقاييس:**

* **Cold start ≤ 2.0s** على جهاز 2GB RAM (Android متوسط).  
* **بناء PDP ≤ 120ms**.  
* **Jank \< 0.5%** في قوائم طويلة.  
* **حجم التطبيق ≤ 40MB** (فشل CI إذا زاد \>5%).  
  **قبول:** ضمن الحدود المذكورة.

## **7\) اختبار الصور/CDN**

**الهدف:** سرعة التحميل وتوفير البيانات.  
**الأدوات:** DevTools Network, Dio Logger.  
**ما نتحقق منه:**

* PLP: صور ≤ 250KB بـ `w=360 q=75`.  
* PDP: الصورة الأولى ≤ 800KB بـ `w=1080 q=80`.  
* WebP/AVIF تعمل مع fallback، Placeholder/Skeleton فعّال.  
  **قبول:** جميع القيود محترمة، عدم تحميل صور أصلية ضخمة.

## **8\) اختبار التحليلات Analytics**

**الهدف:** دقة الـFunnel وربط الأبعاد الثابتة.  
**الأدوات:** DebugView (GA4/Firebase), Logcat, Stubs.  
**نقاط تحقق:**

* `view_item`, `add_to_cart`, `begin_checkout`, `add_shipping_info(city)`, `add_payment_info(type)`, `purchase`.  
* **أبعاد ثابتة**: `region`, `currency=YER`, `channel`, `app_version`, (user\_id مشفّر).  
* **تطابق ≥ 95%** مع أرقام السيرفر أسبوعيًا.  
  **قبول:** عدم وجود Events مفقودة/مضاعفة.

## **9\) اختبار الإشعارات والديب لينك**

**الهدف:** وصول صحيح بدون إزعاج.  
**الأدوات:** Firebase Cloud Messaging، سطر أوامر/لوحة FCM.  
**السيناريوهات:**

* `transactional`: إشعار حالة طلب يفتح شاشة الطلب.  
* `promo`: يفتح صفحة العرض \+ احترام قاعدة “لا Promo خلال 48 ساعة بعد الشراء”.  
  **قبول:** deeplink صحيح، منع رسائل مكررة بعد الشراء.

## **10\) الوصولية والـRTL Accessibility & RTL**

**الهدف:** تجربة ممتازة بالعربية وعلى قارئات الشاشة.  
**الأدوات:** Flutter Semantics, VoiceOver/TalkBack.  
**التحقق:**

* اتجاه RTL صحيح في كل الشاشات.  
* تسميات Semantics للأزرار والصور.  
* تباين النصوص مقروء (لا ألوان فاتحة على فاتح).  
  **قبول:** قابلية استخدام كاملة بدون عوائق.

## **11\) الأمان Security**

**الهدف:** حماية الجلسات والبيانات.  
**الأدوات:** Secure Storage، فحص Logs، (اختياري TLS Pinning).  
**التحقق:**

* **Token refresh** يعمل؛ على الفشل → Logout نظيف.  
* لا حفظ Tokens في `SharedPreferences`.  
* لا طباعة بيانات حساسة في السجلات.  
  **قبول:** اجتياز جميع حالات الانتهاء/التجديد/الرفض.

## **12\) الاستهلاك والطاقة Battery/Memory**

**الهدف:** عدم استنزاف الجهاز.  
**الأدوات:** Android Profiler, Xcode Instruments.  
**التحقق:**

* عدم تسريب ذاكرة (Leaks) في قوائم طويلة والتنقل المتكرر بين PLP↔︎PDP.  
* استهلاك CPU طبيعي عند التمرير والتحميل.  
  **قبول:** بدون Leaks ملحوظة، CPU متوسط مستقر.

## **13\) استعداد النشر Store-Readiness**

**الهدف:** جاهزية النسخة للمتاجر.  
**الأدوات:** `flutter build`, TestFlight, Firebase App Distribution.  
**التحقق:**

* الأذونات (Permissions) مبررة ومستخدمة فعليًا.  
* crash-free sessions ≥ 99.5% على بيتا.  
* لقطات صور/نصوص المتجر بالعربية، ASO أساسي.  
  **قبول:** معايير المتجر مكتملة \+ لا كراشات حرجة.

---

## **مصفوفة الأجهزة/الإصدارات (حد أدنى)**

* **Android:** 8.1, 10, 12 — أجهزة 2GB و4GB RAM (واحد ضعيف/واحد متوسط).  
* **iOS:** 15 و16/17 — iPhone SE (ضعيف نسبيًا) \+ iPhone حديث.  
* **شبكات:** 3G/ضعيف، 4G جيد، Wi-Fi ممتاز.

---

## **تكامل الاختبارات مع CI (مختصر)**

* تشغيل: `flutter analyze && flutter test && flutter test --update-goldens (عند الحاجة) && flutter build appbundle --analyze-size`.  
* تشغيل E2E على **Firebase Test Lab** (Android) \+ **TestFlight** داخلي (iOS).  
* فشل الـCI إذا:  
  * تغطية الوحدات \< 70% (أو حدّك المفضل).  
  * حجم البيلد زاد \> 5%.  
  * أي سيناريو E2E أساسي يفشل.

---

## **سيناريوهات**

1. صنعاء → Checkout COD بدون عربون → نجاح شراء.  
2. تعز/عدن → Checkout يطلب عربون → دفع عربون → نجاح شراء.  
3. كوبون منتهي → رسالة خطأ → السعر لا يتغير.  
4. نفاد مخزون أثناء الدفع → 409 → اقتراح بديل/رجوع للسلة.  
5. تغيير المدينة في الملخص → إعادة حساب الشحن فورًا.  
6. انقطاع الإنترنت في السلة → Offline Queue → عودة الشبكة → تزامن.  
7. إشعار حالة طلب → يفتح شاشة الطلب الصحيحة (deeplink).  
8. إشعار Promo بعد شراء خلال 24 ساعة → **لا يُرسل** (يحترم 48h).  
9. انتهاء صلاحية الـToken أثناء الطلب → Refresh ناجح → تكملة؛ عند فشل التجديد → Logout نظيف برسالة.  
10. PLP على شبكة ضعيفة → صور ≤ 250KB وتعمل الـPlaceholder.


---

## 🏠 **Back to Home | العودة للرئيسية**

[← Back to Main Index | العودة للفهرس الرئيسي](../../../index.html)

---
